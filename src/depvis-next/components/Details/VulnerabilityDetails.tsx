import { gql, useQuery } from "@apollo/client";
import { Badge, Container } from "react-bootstrap";
import { vulnerabilityColorByCVSS } from "../../helpers/GraphHelper";
import Loading from "../Loading/Loading";
import { DL, DLItem } from "./DescriptionList";

const getVulnerabilityDetailsQuery = gql`
  query vulnerabilityDetails($vulnerabilityId: String) {
    vulnerabilities(where: { id: $vulnerabilityId }) {
      id
      name
      cve
      ghsa
      description
      affectedVersions
      cvssScore
      cvssVector
      cwe
      references {
        url
      }
    }
  }
`;
const VulnerabilityDetails = (props) => {
  const { vulnerabilityId } = props;
  const { data, loading, error } = useQuery(getVulnerabilityDetailsQuery, {
    variables: { vulnerabilityId: vulnerabilityId },
  });

  const renderReferences = (referencesList) => {
    if (!referencesList) return;
    return referencesList.map((r, index) => (
      <li className="overflow-text" key={index}>
        <a href={r.url} target="_blank" rel="noreferrer">
          {r.url}
        </a>
      </li>
    ));
  };

  const getCvssScoreLabel = (cvssScore) => {
    if (cvssScore >= 9) return "Critical";
    if (cvssScore >= 7) return "High";
    if (cvssScore >= 4) return "Medium";
    return "Low";
  };
  const renderCvss = (cvssScore) => {
    return (
      <Badge
        style={{
          background: `${vulnerabilityColorByCVSS(cvssScore)}`,
        }}
        bg=""
      >
        {cvssScore} - {getCvssScoreLabel(cvssScore)}
      </Badge>
    );
  };

  const renderCvssVectorAsLink = (cvssVector) => {
    const cvssPortalUrl = "https://www.first.org/cvss/calculator/3.1";
    const url = `${cvssPortalUrl}#${cvssVector}`;
    return (
      <a href={url} target="_blank" rel="noreferrer">
        {cvssVector}
      </a>
    );
  };

  if (loading) return <Loading />;
  if (!data.vulnerabilities[0]) {
    console.error(
      "No data found when querying backend! Below is Apollo query result"
    );
    console.error({ data: data, error: error });
    return <b>No data found!</b>;
  }
  const vulnerability = data.vulnerabilities[0];
  return (
    <Container style={{ wordBreak: "break-word" }} className="px-0">
      <h4 className="pb-3">
        <b>{vulnerability.name}</b>
      </h4>
      <DL>
        <DLItem label="Id" value={vulnerability.id} />
        <DLItem
          label="CVSS Score"
          value={renderCvss(vulnerability.cvssScore)}
          alwaysShow
        />
        <DLItem
          label="CVSS Vector"
          value={renderCvssVectorAsLink(vulnerability.cvssVector)}
        />
        <DLItem label="Description" value={vulnerability.description} />

        <DLItem
          label="affectedVersions"
          value={vulnerability.affectedVersions}
        />
        <DLItem label="CWE" value={vulnerability.cwe} />
        <DLItem
          label="References"
          value={renderReferences(vulnerability.references)}
        />
      </DL>
    </Container>
  );
};

export default VulnerabilityDetails;
