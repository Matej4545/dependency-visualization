import { request } from "../helpers/RequestHelper";
import { IVulnProvider } from "./IVulnProvider";

export class SonatypeOSSVulnProvider implements IVulnProvider {
  /** This class provides implementation for the Sonatype OSS Index API
   * available at https://ossindex.sonatype.org/
   *
   * Sonatype OSS Index support PURL package identifier natively.
   * Use free account to get higher API rate limit
   */
  name = "SonatypeOSS";
  auth_token = "";
  url = "https://ossindex.sonatype.org/api/v3/authorized/component-report";

  constructor() {
    this.auth_token = process.env.NEXT_PUBLIC_SONATYPE_OSS_AUTH;
    if (!this.auth_token) {
      console.warn(
        "No auth token found! Fallback to public API, which might require lower rate limit! %s"
      );
      console.log(process.env.NEXT_PUBLIC_SONATYPE_OSS_AUTH);
      this.url = "https://ossindex.sonatype.org/api/v3/component-report";
    }
  }

  fetchInfo = async (purlList: string[]) => {
    //Prepare headers
    let headers: HeadersInit = {
      accept: "application/json",
      "Content-Type": "application/json",
    };

    //Add auth token if provided
    if (this.auth_token) {
      headers.authorization = `Basic ${this.auth_token}`;
    }
    //Prepare request options
    const requestOptions: RequestInit = {
      method: "POST",
      headers: headers,
      body: JSON.stringify({ coordinates: purlList }),
    };
    const { json, status } = await request(this.url, requestOptions);
    if (status) {
      return this.parseResponse(json);
    } else {
      return [];
    }
  };

  private parseResponse = (response) => {
    if (!response) return [];

    // Response contains array of components with relevant information, could be used to enhance package info
    return response.map((c) => {
      return {
        ...c,
        vulnerabilities: this.transformVulnerabilities(c.vulnerabilities),
      };
    });
  };

  private transformVulnerabilities(vulnerabilityList) {
    return vulnerabilityList.map((v) => {
      return {
        name: v.title,
        cvss: v.cvssScore,
        affectedVersion: v.cwe,
        cve: v.id,
        description: v.description,
        references: [
          { url: v.reference },
          ...v.externalReferences.map((v) => {
            return { url: v };
          }),
        ],
      };
    });
  }
}
